(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();class F{constructor(){this.image=null,this.imageSize={width:0,height:0},this.lines=[],this.vpPos=null,this.vpManual=!1,this.history=["[]"],this.historyIdx=0,this.view={x:0,y:0,scale:1},this.tool="select",this.drawPt=null,this.mousePos=null,this.selectedId=null,this.draggingVP=!1,this.isPanning=!1,this.panStart={x:0,y:0},this.lang="en",this.aiState={isDetecting:!1,detectedSuggestions:[],autoDetectEnabled:!0,opencvLoaded:!1}}addLine(t){this.lines.push(t),this.saveHistory()}deleteLine(t){this.lines=this.lines.filter(e=>e.id!==t),this.saveHistory()}saveHistory(){this.history=this.history.slice(0,this.historyIdx+1),this.history.push(JSON.stringify(this.lines)),this.historyIdx=this.history.length-1}undo(){return this.historyIdx>0?(this.historyIdx--,this.lines=JSON.parse(this.history[this.historyIdx]),!0):!1}redo(){return this.historyIdx<this.history.length-1?(this.historyIdx++,this.lines=JSON.parse(this.history[this.historyIdx]),!0):!1}reset(t=!1){t||(this.lines=[],this.vpPos=null,this.vpManual=!1,this.history=["[]"],this.historyIdx=0),this.drawPt=null,this.selectedId=null,this.aiState.detectedSuggestions=[]}getSourceLines(){return this.lines.filter(t=>!t.isVP&&!t.isPlumb)}getVPLines(){return this.lines.filter(t=>t.isVP)}}const D=1e-9;function S(c,t){const e=t.x-c.x,i=t.y-c.y;let n=-i,s=e,r=i*c.x-e*c.y;const o=Math.sqrt(n*n+s*s);return o<D?null:{a:n/o,b:s/o,c:r/o,p1:{...c},p2:{...t}}}function j(c,t){const e=c.a*t.b-c.b*t.a;return Math.abs(e)<D?null:{x:(c.b*t.c-t.b*c.c)/e,y:(t.a*c.c-c.a*t.c)/e}}function R(c){if(c.length<2)return null;if(c.length===2)return j(c[0],c[1]);let t=0,e=0,i=0,n=0,s=0;for(const o of c)t+=o.a*o.a,e+=o.a*o.b,i+=o.b*o.b,n+=o.a*o.c,s+=o.b*o.c;const r=t*i-e*e;return Math.abs(r)<D?null:{x:(e*s-i*n)/r,y:(e*n-t*s)/r}}function M(c,t){const{a:e,b:i,c:n}=c,{left:s,top:r,right:o,bottom:d}=t,l=[];if(Math.abs(i)>D){let a=-(e*s+n)/i;a>=r&&a<=d&&l.push({x:s,y:a}),a=-(e*o+n)/i,a>=r&&a<=d&&l.push({x:o,y:a})}if(Math.abs(e)>D){let a=-(i*r+n)/e;a>=s&&a<=o&&l.push({x:a,y:r}),a=-(i*d+n)/e,a>=s&&a<=o&&l.push({x:a,y:d})}const v=l.filter((a,f)=>!l.slice(0,f).some(y=>Math.abs(a.x-y.x)<1&&Math.abs(a.y-y.y)<1));return v.length>=2?[v[0],v[1]]:null}function k(c,t){return(c.x-t.x)**2+(c.y-t.y)**2}const T={en:{openImage:"Open Image",sourceLines:"Source",language:"Language",vanishingPoint:"Vanishing Point",drawLines:"Draw at least 2 lines",insideImage:"✓ Inside image",outsideImage:"⚠ Outside image",recalculate:"Recalculate",export:"Export",exportImage:"Image with Lines",exportExtended:"Extended (with VP)",shortcuts:"Shortcuts",select:"Select",drawLine:"Ref Line",vpLineShort:"Offside Line",playerTool:"Player Proj.",deleteTool:"Delete",panTool:"Pan",moveVP:"Move VP",zoom:"Zoom",undo:"Undo",help:"Help",statusSelect:"Click to select. Drag VP or use arrow keys.",statusDraw1:"Click first point of line.",statusDraw2:"Click second point.",statusVP:"Click to create line from VP.",statusVPNone:"No VP. Draw lines first.",statusPlayer1:"Click offside body part (e.g. shoulder).",statusPlayer2:"Click point on ground.",statusDelete:"Click on a line to delete.",statusPan:"Drag to pan.",startTutorial:"Tutorial",guideTitle:"Pro User Guide",tabQuickstart:"Quick Start",tabTheory:"Master Theory",tabTools:"Toolbox",tabAbout:"About",emptyTitle:"Load an image to begin",emptyDesc:"Click 'Open Image' or drag & drop",emptyDescAI:"AI will automatically detect field lines",autoDetect:"Auto-Detect",detecting:"Detecting lines...",loadingOpenCV:"Loading AI engine...",foundLines:"Found {count} lines",noLinesFound:"No lines detected",confidence:"Confidence",acceptSuggestions:"Accept",acceptSelected:"Accept Selected",rejectAll:"Reject All",refineDetection:"Refine",aiDisabled:"AI Detection Disabled",aiEnabled:"AI Detection Enabled",toggleAI:"Toggle AI",avgConfidence:"Avg: {value}%",runDetection:"Run Detection",detectionFailed:"Detection failed",lineNum:"Line {num}",aiPanel:"AI Detection",quickstartContent:`<div class="guide-section"><h3>Quick Workflow</h3><p>Follow these steps for a professional analysis:</p><div class="guide-step"><div class="guide-step-num">1</div><div class="guide-step-content"><h4>Image Setup</h4><p>Use high-resolution images where pitch markings are clearly visible.</p></div></div><div class="guide-step"><div class="guide-step-num">2</div><div class="guide-step-content"><h4>AI Auto-Detection</h4><p>When you load an image, AI automatically detects horizontal field lines. Review the suggestions and click <strong>Accept</strong> to use them.</p></div></div><div class="guide-step"><div class="guide-step-num">3</div><div class="guide-step-content"><h4>Manual Refinement</h4><p>Press <strong>L</strong> to add more reference lines manually if needed. The more lines, the more accurate the VP.</p></div></div><div class="guide-step"><div class="guide-step-num">4</div><div class="guide-step-content"><h4>Player Analysis</h4><p>Press <strong>Y</strong>.<br>1. Click the player's offside body part.<br>2. Move down and click where that point projects on the ground.<br>3. The Orange line shows the offside position.</p></div></div></div>`,theoryContent:`<div class="guide-section"><h3>The Physics of Offside</h3><p>Understanding 2D projections of 3D space is key to VAR analysis.</p><div class="guide-highlight"><strong>What is the Vanishing Point (VP)?</strong><br>In a perspective image, all lines that are parallel in reality converge to a single point. This is the VP.</div><h3>The Parallax Error</h3><p>Why can't I just draw a line from the player's head?</p><ul><li><strong>The Ground Truth:</strong> Offside lines exist on the pitch surface (z=0).</li><li><strong>Projection:</strong> If a player is leaning, their head is "above" the line. We must project that point vertically down to the ground.</li></ul><p>Our <strong>Player Tool (Y)</strong> solves this by forcing you to define the "Body-to-Ground" segment.</p></div>`,toolsContent:'<div class="guide-section"><h3>Tool Reference</h3><div class="guide-step"><div class="guide-step-num">AI</div><div class="guide-step-content"><h4>Auto-Detection</h4><p>Uses OpenCV.js with Hough Transform to detect horizontal lines in the image. Confidence scores help you identify the most reliable detections.</p></div></div><div class="guide-step"><div class="guide-step-num">V</div><div class="guide-step-content"><h4>Select / Move VP</h4><p>Drag VP with mouse or use Arrow keys for precision (Shift+Arrow for 10px).</p></div></div><div class="guide-step"><div class="guide-step-num">L</div><div class="guide-step-content"><h4>Reference Line</h4><p>Draw Blue Lines on horizontal pitch markings.</p></div></div><div class="guide-step"><div class="guide-step-num">Y</div><div class="guide-step-content"><h4>Player Projection</h4><p>Click 1: Body part. Click 2: Ground point. Creates Cyan segment + Orange offside line.</p></div></div></div>',aboutContent:'<div class="guide-section"><h3>Offside Calculator Pro AI</h3><p>Version 4.0 - AI-enhanced version with automatic field line detection.</p><div class="guide-highlight"><strong>AI Features</strong><br>Powered by OpenCV.js with Hough Transform for real-time line detection. No server required - all processing happens in your browser.</div><h3>Developer</h3><p><strong>Maurizio Verde</strong></p><h3>Links</h3><p><a href="https://github.com/maverde73/offside-calculator" target="_blank" style="color: #00ff87;">github.com/maverde73/offside-calculator</a></p><h3>License</h3><p>MIT License (c) 2026 Maurizio Verde</p></div>'},it:{openImage:"Apri Immagine",sourceLines:"Sorgente",language:"Lingua",vanishingPoint:"Punto di Fuga",drawLines:"Disegna almeno 2 linee",insideImage:"✓ Dentro l'immagine",outsideImage:"⚠ Fuori dall'immagine",recalculate:"Ricalcola",export:"Esporta",exportImage:"Immagine con Linee",exportExtended:"Estesa (con VP)",shortcuts:"Scorciatoie",select:"Seleziona",drawLine:"Riferimento",vpLineShort:"Linea F.G.",playerTool:"Proiezione",deleteTool:"Elimina",panTool:"Sposta",moveVP:"Muovi VP",zoom:"Zoom",undo:"Annulla",help:"Aiuto",statusSelect:"Clicca per selezionare. Trascina VP o usa le frecce.",statusDraw1:"Clicca il primo punto.",statusDraw2:"Clicca il secondo punto.",statusVP:"Clicca per creare linea da VP.",statusVPNone:"Nessun VP. Disegna linee prima.",statusPlayer1:"Clicca parte del corpo (es. spalla).",statusPlayer2:"Clicca punto a terra.",statusDelete:"Clicca su una linea per eliminarla.",statusPan:"Trascina per spostare.",startTutorial:"Tutorial",guideTitle:"Manuale Pro",tabQuickstart:"Guida Rapida",tabTheory:"Masterclass Teoria",tabTools:"Strumenti",tabAbout:"Info",emptyTitle:"Carica un'immagine",emptyDesc:"Clicca 'Apri Immagine' o trascina qui",emptyDescAI:"L'AI rileverà automaticamente le linee del campo",autoDetect:"Auto-Rileva",detecting:"Rilevamento in corso...",loadingOpenCV:"Caricamento AI...",foundLines:"Trovate {count} linee",noLinesFound:"Nessuna linea rilevata",confidence:"Affidabilità",acceptSuggestions:"Accetta",acceptSelected:"Accetta Selezionate",rejectAll:"Rifiuta Tutto",refineDetection:"Raffina",aiDisabled:"Rilevamento AI Disattivato",aiEnabled:"Rilevamento AI Attivo",toggleAI:"Attiva/Disattiva AI",avgConfidence:"Media: {value}%",runDetection:"Avvia Rilevamento",detectionFailed:"Rilevamento fallito",lineNum:"Linea {num}",aiPanel:"Rilevamento AI",quickstartContent:`<div class="guide-section"><h3>Flusso di Lavoro</h3><p>Segui questi passaggi per un'analisi precisa:</p><div class="guide-step"><div class="guide-step-num">1</div><div class="guide-step-content"><h4>Caricamento</h4><p>Usa screenshot HD con le linee del campo ben visibili.</p></div></div><div class="guide-step"><div class="guide-step-num">2</div><div class="guide-step-content"><h4>Auto-Rilevamento AI</h4><p>Quando carichi un'immagine, l'AI rileva automaticamente le linee orizzontali. Rivedi i suggerimenti e clicca <strong>Accetta</strong>.</p></div></div><div class="guide-step"><div class="guide-step-num">3</div><div class="guide-step-content"><h4>Raffinamento Manuale</h4><p>Premi <strong>L</strong> per aggiungere altre linee di riferimento se necessario.</p></div></div><div class="guide-step"><div class="guide-step-num">4</div><div class="guide-step-content"><h4>Analisi Giocatore</h4><p>Premi <strong>Y</strong>.<br>1. Clicca sulla parte del corpo in fuorigioco.<br>2. Clicca dove quel punto cade a terra.<br>3. La linea Arancione mostra il fuorigioco.</p></div></div></div>`,theoryContent:`<div class="guide-section"><h3>La Fisica del Fuorigioco</h3><p>Capire la proiezione 2D di uno spazio 3D è fondamentale per l'analisi VAR.</p><div class="guide-highlight"><strong>Cos'è il Punto di Fuga (VP)?</strong><br>In una foto prospettica, tutte le linee parallele nella realtà convergono in un unico punto.</div><h3>Errore di Parallasse</h3><p>Perché non posso tirare una linea dalla testa del giocatore?</p><ul><li><strong>Verità del Terreno:</strong> Le linee di fuorigioco esistono sul piano del campo (z=0).</li><li><strong>Proiezione:</strong> Se un giocatore è inclinato, la sua testa è "sopra" la linea.</li></ul><p>Lo <strong>Strumento Giocatore (Y)</strong> risolve questo problema definendo il segmento "Corpo-Terra".</p></div>`,toolsContent:'<div class="guide-section"><h3>Dettaglio Strumenti</h3><div class="guide-step"><div class="guide-step-num">AI</div><div class="guide-step-content"><h4>Auto-Rilevamento</h4><p>Usa OpenCV.js con Trasformata di Hough per rilevare le linee orizzontali. I punteggi di affidabilità aiutano a identificare i rilevamenti migliori.</p></div></div><div class="guide-step"><div class="guide-step-num">V</div><div class="guide-step-content"><h4>Seleziona / Muovi VP</h4><p>Trascina il VP o usa le frecce (Shift+Frecce per 10px).</p></div></div><div class="guide-step"><div class="guide-step-num">L</div><div class="guide-step-content"><h4>Linea di Riferimento</h4><p>Traccia Linee Blu sulle marcature orizzontali del campo.</p></div></div><div class="guide-step"><div class="guide-step-num">Y</div><div class="guide-step-content"><h4>Proiezione Giocatore</h4><p>Click 1: Parte del corpo. Click 2: Punto a terra. Crea segmento Ciano + linea Arancione.</p></div></div></div>',aboutContent:'<div class="guide-section"><h3>Offside Calculator Pro AI</h3><p>Versione 4.0 - Versione potenziata con AI per il rilevamento automatico delle linee.</p><div class="guide-highlight"><strong>Funzionalità AI</strong><br>Alimentato da OpenCV.js con Trasformata di Hough per il rilevamento in tempo reale. Nessun server richiesto - tutto avviene nel browser.</div><h3>Sviluppatore</h3><p><strong>Maurizio Verde</strong></p><h3>Link</h3><p><a href="https://github.com/maverde73/offside-calculator" target="_blank" style="color: #00ff87;">github.com/maverde73/offside-calculator</a></p><h3>Licenza</h3><p>Licenza MIT (c) 2026 Maurizio Verde</p></div>'}};let E="en";function m(c,t={}){let e=T[E][c]||T.en[c]||c;return Object.keys(t).forEach(i=>{e=e.replace(`{${i}}`,t[i])}),e}function W(c){E=c}function Y(){document.querySelectorAll("[data-i18n]").forEach(c=>{const t=c.getAttribute("data-i18n");T[E][t]&&(c.textContent=T[E][t])})}function q(c,t=.5){return c.filter(e=>e.confidence>=t)}function N(c,t=4){return[...c].sort((e,i)=>i.confidence-e.confidence).slice(0,t)}function V(c){return c.length===0?0:c.reduce((e,i)=>e+i.confidence,0)/c.length}function H(c){return`${Math.round(c*100)}%`}function C(c){return c>=.8?"#00ff87":c>=.6?"#f97316":"#ef4444"}class X{constructor(t,e){this.container=t,this.onAccept=e.onAccept,this.onReject=e.onReject,this.onToggle=e.onToggle,this.onRunDetection=e.onRunDetection,this.suggestions=[],this.aiEnabled=!0,this.render()}render(){this.container.innerHTML=`
      <div class="sidebar-section ai-panel">
        <div class="sidebar-title ai-title">
          <span data-i18n="aiPanel">${m("aiPanel")}</span>
          <button class="btn-toggle-ai" id="btnToggleAI" title="${m("toggleAI")}">
            <span class="ai-indicator ${this.aiEnabled?"active":""}">&#9889;</span>
          </button>
        </div>
        <div id="detectionStatus" class="detection-status"></div>
        <div id="detectionResults" class="detection-results"></div>
        <button class="btn btn-secondary sidebar-btn" id="btnRunDetection" style="display: none;">
          <span data-i18n="runDetection">${m("runDetection")}</span>
        </button>
      </div>
    `,document.getElementById("btnToggleAI").onclick=()=>{this.aiEnabled=!this.aiEnabled,this.onToggle(this.aiEnabled),this.setAIEnabled(this.aiEnabled)},document.getElementById("btnRunDetection").onclick=()=>{this.onRunDetection()}}showIdle(){const t=document.getElementById("detectionStatus");t.innerHTML=`
      <div class="detection-idle">
        <span>${m("emptyDescAI")}</span>
      </div>
    `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="none"}showLoading(){const t=document.getElementById("detectionStatus");t.innerHTML=`
      <div class="detecting-spinner">
        <span class="spinner"></span>
        <span>${m("loadingOpenCV")}</span>
      </div>
    `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="none"}showDetecting(){const t=document.getElementById("detectionStatus");t.innerHTML=`
      <div class="detecting-spinner">
        <span class="spinner"></span>
        <span>${m("detecting")}</span>
      </div>
    `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="none"}showResults(t,e){this.suggestions=t;const i=document.getElementById("detectionStatus");if(t.length===0){i.innerHTML=`
        <div class="detection-summary no-results">
          <span>${m("noLinesFound")}</span>
        </div>
      `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="block";return}i.innerHTML=`
      <div class="detection-summary">
        <span>${m("foundLines",{count:t.length})}</span>
        <span class="confidence-badge" style="background: ${C(e)}">
          ${m("avgConfidence",{value:Math.round(e*100)})}
        </span>
      </div>
    `;const n=document.getElementById("detectionResults");n.innerHTML=`
      <div class="suggestion-list">
        ${t.map((s,r)=>`
          <div class="suggestion-item" data-line-id="${s.id}">
            <input type="checkbox" id="line-${r}" checked />
            <label for="line-${r}">
              <span class="line-number">${r+1}</span>
              <span class="line-confidence" style="color: ${C(s.confidence)}">
                ${H(s.confidence)}
              </span>
            </label>
          </div>
        `).join("")}
      </div>
      <div class="detection-actions">
        <button class="btn btn-primary btn-accept" id="btnAcceptSuggestions">
          ${m("acceptSelected")}
        </button>
        <button class="btn btn-secondary btn-reject" id="btnRejectAll">
          ${m("rejectAll")}
        </button>
      </div>
    `,document.getElementById("btnAcceptSuggestions").onclick=()=>{const s=this.getSelectedSuggestions();this.onAccept(s)},document.getElementById("btnRejectAll").onclick=()=>{this.onReject()},document.getElementById("btnRunDetection").style.display="none"}showError(t){const e=document.getElementById("detectionStatus");e.innerHTML=`
      <div class="detection-error">
        <span>${m("detectionFailed")}: ${t}</span>
      </div>
    `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="block"}showReadyForDetection(){const t=document.getElementById("detectionStatus");t.innerHTML=`
      <div class="detection-ready">
        <span>${this.aiEnabled?m("aiEnabled"):m("aiDisabled")}</span>
      </div>
    `,document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display=this.aiEnabled?"block":"none"}getSelectedSuggestions(){const t=document.querySelectorAll('.suggestion-item input[type="checkbox"]:checked');return Array.from(t).map(e=>{const i=e.closest(".suggestion-item").dataset.lineId;return this.suggestions.find(n=>n.id===i)})}clear(){document.getElementById("detectionStatus").innerHTML="",document.getElementById("detectionResults").innerHTML="",document.getElementById("btnRunDetection").style.display="none"}setAIEnabled(t){this.aiEnabled=t;const e=document.querySelector(".ai-indicator");e&&(e.classList.toggle("active",t),e.style.opacity=t?"1":"0.3");const i=document.getElementById("btnRunDetection");i&&(i.style.display=t?"block":"none")}updateLanguage(){const t=this.aiEnabled;this.suggestions.length>0,this.render(),this.setAIEnabled(t)}}function G(c,t,e){if(!t.isAIDetected||!t.confidence||!t.isPending)return;const i=(t.p1.x+t.p2.x)/2,n=(t.p1.y+t.p2.y)/2;c.save(),c.font=`bold ${12/e.scale}px Montserrat, sans-serif`;const s=H(t.confidence),r=c.measureText(s),o=4/e.scale;c.fillStyle="rgba(15, 23, 42, 0.8)",c.fillRect(i-r.width/2-o,n-10/e.scale-o,r.width+o*2,14/e.scale+o*2),c.fillStyle=C(t.confidence),c.textAlign="center",c.fillText(s,i,n),c.restore()}class U{constructor(t,e,i){this.canvas=t,this.ctx=t.getContext("2d"),this.container=e,this.state=i}render(){const{canvas:t,ctx:e,container:i,state:n}=this,{image:s,imageSize:r,lines:o,vpPos:d,view:l,tool:v,drawPt:a,mousePos:f,selectedId:y,draggingVP:b}=n;t.width=i.clientWidth,t.height=i.clientHeight,e.fillStyle="#1e293b",e.fillRect(0,0,t.width,t.height),e.save(),e.translate(l.x,l.y),e.scale(l.scale,l.scale),s&&e.drawImage(s,0,0);const P={left:-l.x/l.scale-200,top:-l.y/l.scale-200,right:(t.width-l.x)/l.scale+200,bottom:(t.height-l.y)/l.scale+200},w=n.aiState.detectedSuggestions;if(w.length>0){for(const u of w){const h=M(u.geo,P);h&&(e.beginPath(),e.moveTo(h[0].x,h[0].y),e.lineTo(h[1].x,h[1].y),e.strokeStyle="rgba(59, 130, 246, 0.5)",e.lineWidth=3/l.scale,e.setLineDash([12/l.scale,6/l.scale]),e.stroke(),G(e,u,l))}e.setLineDash([])}for(const u of o)if(u.isPlumb){const h=u.geo.p1,g=u.geo.p2;e.beginPath(),e.moveTo(h.x,h.y),e.lineTo(g.x,g.y),e.strokeStyle="#22d3ee",e.lineWidth=2/l.scale,e.setLineDash([2/l.scale,3/l.scale]),e.stroke(),e.beginPath(),e.arc(h.x,h.y,4/l.scale,0,Math.PI*2),e.fillStyle="#22d3ee",e.fill();const p=5/l.scale;e.beginPath(),e.moveTo(g.x-p,g.y-p),e.lineTo(g.x+p,g.y+p),e.moveTo(g.x+p,g.y-p),e.lineTo(g.x-p,g.y+p),e.strokeStyle="#22d3ee",e.setLineDash([]),e.lineWidth=2/l.scale,e.stroke()}else{const h=M(u.geo,P);if(!h)continue;e.beginPath(),e.moveTo(h[0].x,h[0].y),e.lineTo(h[1].x,h[1].y),e.strokeStyle=u.id===y?"#fff":u.color,e.lineWidth=(u.id===y?4:3)/l.scale,e.setLineDash(u.isVP?[12/l.scale,6/l.scale]:[]),e.shadowColor=u.color,e.shadowBlur=(u.id===y?10:5)/l.scale,e.stroke(),e.shadowBlur=0}if(e.setLineDash([]),a&&f){const u=v==="player"?{x:a.x,y:f.y}:f;if(v==="player"){e.beginPath(),e.moveTo(P.left,f.y),e.lineTo(P.right,f.y),e.strokeStyle="rgba(34, 211, 238, 0.3)",e.lineWidth=1/l.scale,e.setLineDash([8/l.scale,4/l.scale]),e.stroke(),e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(u.x,u.y),e.strokeStyle="#22d3ee",e.lineWidth=2/l.scale,e.setLineDash([2/l.scale,3/l.scale]),e.stroke(),e.beginPath(),e.arc(a.x,a.y,4/l.scale,0,Math.PI*2),e.fillStyle="#22d3ee",e.fill();const h=5/l.scale;e.beginPath(),e.moveTo(u.x-h,u.y-h),e.lineTo(u.x+h,u.y+h),e.moveTo(u.x+h,u.y-h),e.lineTo(u.x-h,u.y+h),e.strokeStyle="#22d3ee",e.setLineDash([]),e.lineWidth=2/l.scale,e.stroke(),d&&(e.beginPath(),e.moveTo(u.x,u.y),e.lineTo(d.x,d.y),e.strokeStyle="rgba(249, 115, 22, 0.4)",e.setLineDash([]),e.stroke())}else e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(u.x,u.y),e.strokeStyle="rgba(0, 255, 135, 0.6)",e.lineWidth=2/l.scale,e.setLineDash([8/l.scale,4/l.scale]),e.stroke(),e.setLineDash([]),e.beginPath(),e.arc(a.x,a.y,4/l.scale,0,Math.PI*2),e.fillStyle="#00ff87",e.fill()}if(d){const u=20/l.scale;e.shadowColor="#00ff87",e.shadowBlur=20/l.scale,e.strokeStyle="#00ff87",e.lineWidth=3/l.scale,e.beginPath(),e.moveTo(d.x-u*2,d.y),e.lineTo(d.x+u*2,d.y),e.moveTo(d.x,d.y-u*2),e.lineTo(d.x,d.y+u*2),e.stroke(),e.beginPath(),e.arc(d.x,d.y,u,0,Math.PI*2),e.stroke(),e.beginPath(),e.arc(d.x,d.y,4/l.scale,0,Math.PI*2),e.fillStyle="#00ff87",e.fill(),e.shadowBlur=0}e.restore(),s&&f&&(v==="draw"||v==="vpLine"||v==="player"||v==="select"&&b)&&this.renderMagnifier()}renderMagnifier(){const{canvas:t,ctx:e,state:i}=this,{image:n,mousePos:s,view:r}=i,o=140,d=4,l=20,v=s.x*r.scale+r.x,a=s.y*r.scale+r.y;let f=l,y=l;v<o+l*2&&a<o+l*2&&(f=t.width-o-l),e.save(),e.fillStyle="#000",e.fillRect(f,y,o,o),e.lineWidth=2,e.strokeStyle="#fff",e.strokeRect(f,y,o,o),e.beginPath(),e.rect(f,y,o,o),e.clip();let b=o/d,P=o/d,w=s.x-b/2,u=s.y-P/2,h=0,g=0;w<0&&(h=-w*d,b+=w,w=0),u<0&&(g=-u*d,P+=u,u=0),w+b>n.width&&(b=n.width-w),u+P>n.height&&(P=n.height-u),b>0&&P>0&&e.drawImage(n,w,u,b,P,f+h,y+g,b*d,P*d),e.strokeStyle="rgba(255, 0, 0, 0.5)",e.lineWidth=1,e.beginPath(),e.moveTo(f+o/2,y),e.lineTo(f+o/2,y+o),e.moveTo(f,y+o/2),e.lineTo(f+o,y+o/2),e.stroke(),e.restore()}fitToView(){const{canvas:t,container:e,state:i}=this,{image:n,imageSize:s}=i;if(!n)return;const r=40,o=(e.clientWidth-r*2)/s.width,d=(e.clientHeight-r*2)/s.height;i.view.scale=Math.min(o,d,1),i.view.x=(e.clientWidth-s.width*i.view.scale)/2,i.view.y=(e.clientHeight-s.height*i.view.scale)/2,this.render()}toCanvas(t,e){const i=this.canvas.getBoundingClientRect(),{view:n}=this.state;return{x:(t-i.left-n.x)/n.scale,y:(e-i.top-n.y)/n.scale}}findLine(t){const e=12/this.state.view.scale;for(const i of this.state.lines)if(Math.abs(i.geo.a*t.x+i.geo.b*t.y+i.geo.c)<e)return i;return null}}function B(c,t=!1){const{image:e,imageSize:i,lines:n,vpPos:s}=c;if(!e)return;let r=i.width,o=i.height,d=0,l=0;if(t&&s){const g=Math.min(0,s.x-50),p=Math.min(0,s.y-50),I=Math.max(r,s.x+50),A=Math.max(o,s.y+50);r=I-g,o=A-p,d=-g,l=-p}const v=document.createElement("canvas");v.width=r,v.height=o;const a=v.getContext("2d");a.fillStyle="#1e293b",a.fillRect(0,0,r,o),a.drawImage(e,d,l);const f={left:-d,top:-l,right:r-d,bottom:o-l};for(const g of n)if(g.isPlumb){const p={x:g.geo.p1.x+d,y:g.geo.p1.y+l},I={x:g.geo.p2.x+d,y:g.geo.p2.y+l};a.beginPath(),a.moveTo(p.x,p.y),a.lineTo(I.x,I.y),a.strokeStyle="#22d3ee",a.lineWidth=2,a.setLineDash([2,3]),a.stroke(),a.setLineDash([]),a.beginPath(),a.arc(p.x,p.y,4,0,Math.PI*2),a.fillStyle="#22d3ee",a.fill(),a.beginPath(),a.moveTo(I.x-5,I.y-5),a.lineTo(I.x+5,I.y+5),a.moveTo(I.x+5,I.y-5),a.lineTo(I.x-5,I.y+5),a.stroke()}else{const p=M(g.geo,f);if(!p)continue;a.beginPath(),a.moveTo(p[0].x+d,p[0].y+l),a.lineTo(p[1].x+d,p[1].y+l),a.strokeStyle=g.color,a.lineWidth=3,a.setLineDash(g.isVP?[12,6]:[]),a.stroke()}if(a.setLineDash([]),s){const g=s.x+d,p=s.y+l;a.strokeStyle="#00ff87",a.lineWidth=3,a.beginPath(),a.moveTo(g-40,p),a.lineTo(g+40,p),a.moveTo(g,p-40),a.lineTo(g,p+40),a.stroke(),a.beginPath(),a.arc(g,p,20,0,Math.PI*2),a.stroke()}const y="github.com/maverde73/offside-calculator";a.font="14px Montserrat, sans-serif";const b=a.measureText(y).width,P=12,w=r-b-P*2-10,u=o-30;a.fillStyle="rgba(0, 0, 0, 0.7)",a.fillRect(w-P,u-18,b+P*2,28),a.fillStyle="#00ff87",a.fillText(y,w,u);const h=document.createElement("a");h.download="offside_analysis_ai.png",h.href=v.toDataURL("image/png"),h.click()}let x=!1,L=null;async function K(){return x?!0:L||(L=new Promise((c,t)=>{if(typeof cv<"u"&&cv.Mat){x=!0,c(!0);return}const e=document.createElement("script");e.src="https://docs.opencv.org/4.5.5/opencv.js",e.async=!0,e.onload=()=>{setTimeout(()=>{if(typeof cv<"u")if(cv.Mat)x=!0,c(!0);else if(cv.onRuntimeInitialized!==void 0)cv.onRuntimeInitialized=()=>{x=!0,c(!0)};else{const n=setInterval(()=>{typeof cv<"u"&&cv.Mat&&(clearInterval(n),x=!0,c(!0))},100);setTimeout(()=>{clearInterval(n),x||t(new Error("OpenCV initialization timeout"))},3e4)}else t(new Error("OpenCV failed to load"))},100)},e.onerror=()=>{L=null,t(new Error("Failed to load OpenCV script from CDN"))},document.head.appendChild(e)}),L)}class _{constructor(){this.minLineLength=80,this.maxLineGap=15,this.cannyLow=50,this.cannyHigh=150,this.houghThreshold=80,this.angleToleranceDeg=20}async detect(t,e={}){if(!await K())throw new Error("OpenCV not available");Object.assign(this,e);const n=cv.imread(t),s=new cv.Mat,r=new cv.Mat,o=new cv.Mat;try{cv.cvtColor(n,s,cv.COLOR_RGBA2GRAY);const d=new cv.Size(5,5);cv.GaussianBlur(s,s,d,0,0,cv.BORDER_DEFAULT),cv.Canny(s,r,this.cannyLow,this.cannyHigh),cv.HoughLinesP(r,o,1,Math.PI/180,this.houghThreshold,this.minLineLength,this.maxLineGap);const l=[];for(let a=0;a<o.rows;a++){const f=o.data32S[a*4],y=o.data32S[a*4+1],b=o.data32S[a*4+2],P=o.data32S[a*4+3],w=Math.atan2(P-y,b-f)*(180/Math.PI),u=Math.abs(w);if(u<=this.angleToleranceDeg||u>=180-this.angleToleranceDeg){const h={x:f,y},g={x:b,y:P},p=S(h,g);if(p){const I=Math.sqrt((b-f)**2+(P-y)**2),A=Math.min(u,180-u),z=Math.min(I/400,1),O=1-A/this.angleToleranceDeg,$=z*.4+O*.6;l.push({id:`ai-${Date.now()}-${a}`,geo:p,p1:h,p2:g,color:"#3b82f6",isVP:!1,isAIDetected:!0,isPending:!0,confidence:$,length:I,angle:w})}}}const v=this.mergeSimilarLines(l);return v.sort((a,f)=>f.confidence-a.confidence),v}finally{n.delete(),s.delete(),r.delete(),o.delete()}}mergeSimilarLines(t){const e=[],i=new Set;for(let n=0;n<t.length;n++){if(i.has(n))continue;const s=t[n],r=[s];for(let o=n+1;o<t.length;o++){if(i.has(o))continue;const d=t[o],l=Math.abs(s.angle-d.angle),v=(s.p1.y+s.p2.y)/2,a=(d.p1.y+d.p2.y)/2,f=Math.abs(v-a);l<5&&f<30&&(r.push(d),i.add(o))}if(r.length>1){const o=this.averageLines(r);e.push(o)}else e.push(s)}return e}averageLines(t){let e=1/0,i=-1/0,n=0,s=0;for(const a of t)e=Math.min(e,a.p1.x,a.p2.x),i=Math.max(i,a.p1.x,a.p2.x),n+=a.p1.y+a.p2.y,s+=2;const r=n/s,o={x:e,y:r},d={x:i,y:r},l=Math.max(...t.map(a=>a.confidence)),v=S(o,d);return{id:`ai-${Date.now()}-merged-${Math.random().toString(36).substr(2,9)}`,geo:v,p1:o,p2:d,color:"#3b82f6",isVP:!1,isAIDetected:!0,isPending:!0,confidence:l,length:Math.sqrt((d.x-o.x)**2+(d.y-o.y)**2),angle:Math.atan2(d.y-o.y,d.x-o.x)*(180/Math.PI)}}setParameters(t){Object.assign(this,t)}}class Q{constructor(){this.state=new F,this.canvas=null,this.canvasManager=null,this.lineDetector=new _,this.detectionPanel=null,this.init()}init(){this.canvasEl=document.getElementById("canvas"),this.container=document.getElementById("canvasContainer"),this.canvasManager=new U(this.canvasEl,this.container,this.state),this.setupDetectionPanel(),this.setupEventHandlers(),this.updateStatus(),this.canvasManager.render()}setupDetectionPanel(){const t=document.getElementById("aiPanelContainer");this.detectionPanel=new X(t,{onAccept:e=>this.acceptSuggestions(e),onReject:()=>this.rejectSuggestions(),onToggle:e=>this.toggleAI(e),onRunDetection:()=>this.runAutoDetection()}),this.detectionPanel.showIdle()}setupEventHandlers(){document.getElementById("btnOpen").onclick=()=>{document.getElementById("fileInput").click()},document.getElementById("fileInput").onchange=t=>{var i;const e=(i=t.target.files)==null?void 0:i[0];e&&this.loadImage(e)},document.querySelectorAll(".tool-btn[data-tool]").forEach(t=>{t.onclick=()=>{this.state.tool=t.dataset.tool,this.state.drawPt=null,this.updateStatus(),this.canvasManager.render()}}),document.getElementById("btnUndo").onclick=()=>{this.state.undo()&&(this.state.vpManual=!1,this.state.vpPos=this.calcVP(),this.canvasManager.render())},document.getElementById("btnRedo").onclick=()=>{this.state.redo()&&this.canvasManager.render()},document.getElementById("btnZoomIn").onclick=()=>{this.state.view.scale*=1.25,this.canvasManager.render(),this.updateStatus()},document.getElementById("btnZoomOut").onclick=()=>{this.state.view.scale*=.8,this.canvasManager.render(),this.updateStatus()},document.getElementById("btnFit").onclick=()=>{this.canvasManager.fitToView(),this.updateStatus()},document.getElementById("btnRecalc").onclick=()=>{this.state.vpManual=!1,this.state.vpPos=this.calcVP(),this.canvasManager.render(),this.updateStatus()},document.getElementById("btnExport").onclick=()=>B(this.state,!1),document.getElementById("btnExportExt").onclick=()=>B(this.state,!0),document.querySelectorAll(".lang-btn").forEach(t=>{t.onclick=()=>{const e=t.dataset.lang;if(W(e),this.state.lang=e,Y(),document.querySelectorAll(".lang-btn").forEach(i=>{i.classList.toggle("active",i.dataset.lang===e)}),this.updateStatus(),this.detectionPanel.updateLanguage(),this.setupDetectionPanel(),this.state.aiState.detectedSuggestions.length>0){const i=V(this.state.aiState.detectedSuggestions);this.detectionPanel.showResults(this.state.aiState.detectedSuggestions,i)}}}),document.getElementById("btnHelp").onclick=()=>this.openHelp(),document.getElementById("btnCloseHelp").onclick=()=>this.closeHelp(),document.getElementById("helpModal").onclick=t=>{t.target.id==="helpModal"&&this.closeHelp()},document.querySelectorAll(".modal-tab").forEach(t=>{t.onclick=()=>this.showTab(t.dataset.tab)}),document.getElementById("btnTutorial").onclick=()=>this.openHelp(),this.setupCanvasEvents(),this.setupKeyboardShortcuts(),this.container.addEventListener("dragover",t=>t.preventDefault()),this.container.addEventListener("drop",t=>{t.preventDefault();const e=t.dataTransfer.files[0];e&&e.type.startsWith("image/")&&this.loadImage(e)}),window.addEventListener("resize",()=>this.canvasManager.render())}setupCanvasEvents(){const t=this.canvasEl;t.addEventListener("mousedown",e=>{var s;const i=this.canvasManager.toCanvas(e.clientX,e.clientY),{state:n}=this;if(n.vpPos&&n.tool==="select"&&Math.sqrt(k(i,n.vpPos))<25/n.view.scale){n.draggingVP=!0;return}if(n.tool==="pan"||e.button===1){n.isPanning=!0,n.panStart={x:e.clientX-n.view.x,y:e.clientY-n.view.y},this.container.style.cursor="grabbing";return}if(n.tool==="draw")if(!n.drawPt)n.drawPt=i;else{const r=S(n.drawPt,i);r&&(n.lines.push({id:Date.now(),geo:r,isVP:!1,color:"#3b82f6"}),n.vpManual||(n.vpPos=this.calcVP()),n.saveHistory()),n.drawPt=null}else if(n.tool==="vpLine"&&n.vpPos){const r=S(n.vpPos,i);r&&(n.lines.push({id:Date.now(),geo:r,isVP:!0,srcPt:i,color:"#f97316"}),n.saveHistory())}else if(n.tool==="player")if(!n.drawPt)n.drawPt=i;else{const r={x:n.drawPt.x,y:i.y},o=S(n.drawPt,r);if(o){if(n.lines.push({id:Date.now(),geo:o,isVP:!1,isPlumb:!0,color:"#22d3ee"}),n.vpPos){const d=S(n.vpPos,r);d&&n.lines.push({id:Date.now()+1,geo:d,isVP:!0,srcPt:r,color:"#f97316"})}n.saveHistory()}n.drawPt=null}else if(n.tool==="delete"){const r=this.canvasManager.findLine(i);r&&(n.lines=n.lines.filter(o=>o.id!==r.id),n.vpManual||(n.vpPos=this.calcVP()),n.saveHistory())}else n.tool==="select"&&(n.selectedId=((s=this.canvasManager.findLine(i))==null?void 0:s.id)||null);this.updateStatus(),this.canvasManager.render()}),t.addEventListener("mousemove",e=>{const i=this.canvasManager.toCanvas(e.clientX,e.clientY),{state:n}=this;n.mousePos=i,n.draggingVP&&(n.vpManual=!0,n.vpPos=i,this.updateVPLines(i)),n.isPanning&&(n.view.x=e.clientX-n.panStart.x,n.view.y=e.clientY-n.panStart.y),this.canvasManager.render()}),t.addEventListener("mouseup",()=>{const{state:e}=this;e.draggingVP&&e.saveHistory(),e.draggingVP=!1,e.isPanning=!1,e.tool==="pan"&&(this.container.style.cursor="grab")}),t.addEventListener("wheel",e=>{e.preventDefault();const i=this.canvasManager.toCanvas(e.clientX,e.clientY),n=e.deltaY>0?.9:1.1,{state:s}=this;s.view.scale=Math.max(.05,Math.min(20,s.view.scale*n));const r=t.getBoundingClientRect();s.view.x=e.clientX-i.x*s.view.scale-r.left,s.view.y=e.clientY-i.y*s.view.scale-r.top,this.updateStatus(),this.canvasManager.render()},{passive:!1})}setupKeyboardShortcuts(){document.addEventListener("keydown",t=>{const{state:e}=this;if(t.key==="Escape")e.drawPt=null,e.tool="select";else if(t.key==="F1")t.preventDefault(),this.openHelp();else if(t.key==="v")e.tool="select";else if(t.key==="l")e.tool="draw";else if(t.key==="p")e.tool="vpLine";else if(t.key==="y")e.tool="player";else if(t.key==="d")e.tool="delete";else if(t.key==="h")e.tool="pan";else if(t.key===" ")t.preventDefault(),e.tool="pan";else if(t.ctrlKey&&t.key==="z")t.preventDefault(),e.undo()&&(e.vpManual=!1,e.vpPos=this.calcVP());else if(t.ctrlKey&&t.key==="y")t.preventDefault(),e.redo();else if(t.key==="Delete"&&e.selectedId)e.lines=e.lines.filter(i=>i.id!==e.selectedId),e.vpManual||(e.vpPos=this.calcVP()),e.saveHistory(),e.selectedId=null;else if(e.vpPos&&t.key.startsWith("Arrow")){const i=t.shiftKey?10:1;let n=0,s=0;t.key==="ArrowLeft"&&(n=-i/e.view.scale),t.key==="ArrowRight"&&(n=i/e.view.scale),t.key==="ArrowUp"&&(s=-i/e.view.scale),t.key==="ArrowDown"&&(s=i/e.view.scale),(n||s)&&(t.preventDefault(),e.vpManual=!0,e.vpPos={x:e.vpPos.x+n,y:e.vpPos.y+s},this.updateVPLines(e.vpPos))}this.updateStatus(),this.canvasManager.render()}),document.addEventListener("keyup",t=>{t.key===" "&&(this.state.tool="select",this.updateStatus(),this.canvasManager.render())})}async loadImage(t){const{state:e}=this;if(e.lines.length>0){const n=e.lang==="it"?`Ci sono già delle linee disegnate. Vuoi mantenerle per la nuova immagine?

• OK = Mantieni le linee
• Annulla = Cancella tutto e ricomincia`:`There are existing lines. Do you want to keep them for the new image?

• OK = Keep lines
• Cancel = Clear all and start fresh`,s=confirm(n);e.reset(!s)}else e.reset(!1);const i=new FileReader;i.onload=async n=>{const s=new Image;s.onload=async()=>{e.image=s,e.imageSize={width:s.width,height:s.height},document.getElementById("emptyState").style.display="none",this.canvasManager.fitToView(),this.updateStatus(),e.aiState.autoDetectEnabled?await this.runAutoDetection():this.detectionPanel.showReadyForDetection()},s.src=n.target.result},i.readAsDataURL(t)}async runAutoDetection(){const{state:t}=this;if(t.image)try{t.aiState.isDetecting=!0,this.detectionPanel.showLoading();const e=await this.lineDetector.detect(t.image),i=q(e,.5),n=N(i,6),s=V(n);t.aiState.detectedSuggestions=n,t.aiState.isDetecting=!1,this.detectionPanel.showResults(n,s),this.canvasManager.render()}catch(e){console.error("Detection failed:",e),t.aiState.isDetecting=!1,this.detectionPanel.showError(e.message)}}acceptSuggestions(t){const{state:e}=this;for(const n of t)e.lines.push({...n,isPending:!1,isAIDetected:!0});const i=e.getSourceLines();i.length>=2&&(e.vpPos=R(i.map(n=>n.geo))),e.saveHistory(),e.aiState.detectedSuggestions=[],this.detectionPanel.clear(),this.detectionPanel.showReadyForDetection(),this.updateStatus(),this.canvasManager.render()}rejectSuggestions(){this.state.aiState.detectedSuggestions=[],this.detectionPanel.clear(),this.detectionPanel.showReadyForDetection(),this.canvasManager.render()}toggleAI(t){this.state.aiState.autoDetectEnabled=t,this.detectionPanel.setAIEnabled(t),t||(this.state.aiState.detectedSuggestions=[],this.canvasManager.render())}calcVP(){const t=this.state.getSourceLines();return t.length>=2?R(t.map(e=>e.geo)):null}updateVPLines(t){if(!t)return;const{state:e}=this;e.lines=e.lines.map(i=>{if(!i.isVP)return i;let n;if(i.srcPt)n=i.srcPt;else{const r={left:0,top:0,right:e.imageSize.width,bottom:e.imageSize.height},o=M(i.geo,r);n=o?k(o[0],t)>k(o[1],t)?o[0]:o[1]:i.geo.p2}if(!n)return i;const s=S(t,n);return s?{...i,geo:s}:i})}updateStatus(){const{state:t}=this,e={select:m("statusSelect"),draw:t.drawPt?m("statusDraw2"):m("statusDraw1"),vpLine:t.vpPos?m("statusVP"):m("statusVPNone"),player:t.drawPt?m("statusPlayer2"):m("statusPlayer1"),delete:m("statusDelete"),pan:m("statusPan")};document.getElementById("statusHint").textContent=e[t.tool],document.getElementById("vpX").textContent=t.vpPos?t.vpPos.x.toFixed(1):"--",document.getElementById("vpY").textContent=t.vpPos?t.vpPos.y.toFixed(1):"--";const i=document.getElementById("vpStatus");if(t.vpPos){const s=t.vpPos.x>=0&&t.vpPos.x<=t.imageSize.width&&t.vpPos.y>=0&&t.vpPos.y<=t.imageSize.height;i.innerHTML=m(s?"insideImage":"outsideImage"),i.className="vp-status "+(s?"inside":"outside")}else i.innerHTML=m("drawLines"),i.className="vp-status";document.getElementById("vpCoords").textContent=t.vpPos?`VP: (${Math.round(t.vpPos.x)}, ${Math.round(t.vpPos.y)})`:"VP: --",document.getElementById("sourceCount").textContent=t.getSourceLines().length,document.getElementById("vpCount").textContent=t.getVPLines().length,document.getElementById("zoomIndicator").textContent=Math.round(t.view.scale*100)+"%",document.querySelectorAll(".tool-btn[data-tool]").forEach(s=>{s.classList.toggle("active",s.dataset.tool===t.tool)}),document.getElementById("emptyState").style.display=t.image?"none":"block";const n={select:"default",draw:"crosshair",vpLine:"crosshair",player:"crosshair",delete:"pointer",pan:"grab"};this.container.style.cursor=n[t.tool]||"default"}openHelp(){document.getElementById("helpModal").classList.add("open"),this.showTab("quickstart")}closeHelp(){document.getElementById("helpModal").classList.remove("open")}showTab(t){document.querySelectorAll(".modal-tab").forEach(e=>{e.classList.toggle("active",e.dataset.tab===t)}),document.getElementById("modalContent").innerHTML=m(t+"Content")||""}}new Q;
